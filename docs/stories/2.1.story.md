# Story 2.1: Employer Registration & Company Profile

**Status**: Draft

**Story**

As a hiring manager,
I want to register an employer account and create a basic company profile,
so that I can post jobs and represent my company on the platform.

**Acceptance Criteria**

1. The registration flow allows a user to choose an "Employer" account type.
2. An employer user is prompted to create a basic company profile (e.g., company name, website, brief description) after their first login.
3. The system backend distinguishes between "Job Seeker" and "Employer" user roles, granting different permissions for each.
4. The company profile information is saved and associated with the employer's user account.

**Tasks / Subtasks**

- [ ] **Task 1: Update User Registration to Support Role Selection (AC: 1, 3)**
  - [ ] Subtask 1.1: Update registration form UI to include "Account Type" radio buttons (Job Seeker / Employer). [Source: AC 1]
  - [ ] Subtask 1.2: Update `RegisterDto` in shared types to include `role: 'JOB_SEEKER' | 'RECRUITER'` field. [Source: architecture/4-data-models.md#model-user]
  - [ ] Subtask 1.3: Update backend `/api/v1/auth/register` endpoint to accept and validate `role` field. [Source: AC 1]
  - [ ] Subtask 1.4: Update `UserService.register()` to save user with selected role in database. [Source: architecture/11-backend-architecture.md]
  - [ ] Subtask 1.5: Add validation to ensure `role` is either 'JOB_SEEKER' or 'RECRUITER'. [Source: architecture/15-security-and-performance.md#backend-security]

- [ ] **Task 2: Create Company Entity and Database Schema (AC: 4)**
  - [ ] Subtask 2.1: Create `Company` entity in `apps/api/src/main/java/com/recruitify/entities/Company.java` with fields: `id`, `userId`, `name`, `website`, `description`, `logoUrl`, `createdAt`, `updatedAt`. [Source: Inferred from AC 2, 4]
  - [ ] Subtask 2.2: Create `CompanyRepository` interface extending `JpaRepository<Company, UUID>`. [Source: architecture/11-backend-architecture.md#data-access-layer-dal]
  - [ ] Subtask 2.3: Add custom repository method `Optional<Company> findByUserId(UUID userId)`. [Source: AC 4 - link company to employer]
  - [ ] Subtask 2.4: Create database migration file for `companies` table with foreign key to `users(id)`. [Source: architecture/9-database-schema.md]
  - [ ] Subtask 2.5: Add unique constraint on `user_id` (one company per employer user). [Source: Business logic]
  - [ ] Subtask 2.6: Add index on `user_id` for query optimization. [Source: architecture/9-database-schema.md patterns]

- [ ] **Task 3: Implement Role-Based Authorization (AC: 3)**
  - [ ] Subtask 3.1: Update Spring Security configuration to support role-based access control. [Source: architecture/15-security-and-performance.md#authentication-security]
  - [ ] Subtask 3.2: Create `@PreAuthorize("hasRole('RECRUITER')")` annotation for employer-only endpoints. [Source: architecture/11-backend-architecture.md#security-architecture]
  - [ ] Subtask 3.3: Create `@PreAuthorize("hasRole('JOB_SEEKER')")` annotation for job seeker-only endpoints. [Source: architecture/11-backend-architecture.md#security-architecture]
  - [ ] Subtask 3.4: Update JWT token generation to include user role in claims. [Source: Story 1.2 JWT implementation]
  - [ ] Subtask 3.5: Update frontend auth store to store and check user role. [Source: architecture/10-frontend-architecture.md]

- [ ] **Task 4: Create Company Profile Form Component (AC: 2)**
  - [ ] Subtask 4.1: Create `apps/web/src/features/employer/CompanyProfileForm.tsx` component. [Source: architecture/10-frontend-architecture.md#component-organization]
  - [ ] Subtask 4.2: Form includes fields: Company Name (required), Website (optional, URL validation), Description (required, textarea). [Source: AC 2]
  - [ ] Subtask 4.3: Use Ant Design `Form`, `Input`, `Input.TextArea`, and `Button` components. [Source: architecture/3-tech-stack.md]
  - [ ] Subtask 4.4: Add form validation: required fields, URL format for website, max length constraints. [Source: architecture/17-coding-standards.md]
  - [ ] Subtask 4.5: Add loading state and error handling for form submission. [Source: UX best practice]

- [ ] **Task 5: Create Backend Company Service and API (AC: 2, 4)**
  - [ ] Subtask 5.1: Create `CompanyService` in `apps/api/src/main/java/com/recruitify/service/CompanyService.java`. [Source: architecture/11-backend-architecture.md#service-architecture]
  - [ ] Subtask 5.2: Implement `createCompany(userId, CompanyDto)` method that creates company linked to employer user. [Source: AC 4]
  - [ ] Subtask 5.3: Implement `getCompanyByUserId(userId)` method to retrieve employer's company. [Source: AC 2 - check if profile exists]
  - [ ] Subtask 5.4: Implement `updateCompany(companyId, CompanyDto)` method for future profile edits. [Source: Future-proofing]
  - [ ] Subtask 5.5: Add validation to ensure only one company per employer user. [Source: Business logic]

- [ ] **Task 6: Create Company Controller and API Endpoints (AC: 2, 4)**
  - [ ] Subtask 6.1: Create `CompanyController` in `apps/api/src/main/java/com/recruitify/controller/CompanyController.java`. [Source: architecture/11-backend-architecture.md#controllerroute-organization]
  - [ ] Subtask 6.2: Implement `POST /api/v1/companies` endpoint (authenticated, RECRUITER role only). [Source: AC 2, 4]
  - [ ] Subtask 6.3: Implement `GET /api/v1/companies/me` endpoint to get current employer's company. [Source: AC 2 - check if exists]
  - [ ] Subtask 6.4: Implement `PUT /api/v1/companies/{id}` endpoint for updating company profile. [Source: Future-proofing]
  - [ ] Subtask 6.5: Return proper HTTP status codes (201 Created, 200 OK, 400 Bad Request, 403 Forbidden). [Source: REST best practices]

- [ ] **Task 7: Create Shared TypeScript Types for Company (AC: 2, 4)**
  - [ ] Subtask 7.1: Create `packages/shared-types/company.ts` with `Company` interface. [Source: architecture/17-coding-standards.md#critical-fullstack-rules]
  - [ ] Subtask 7.2: Define `Company` interface with fields: `id`, `userId`, `name`, `website`, `description`, `logoUrl`, `createdAt`, `updatedAt`. [Source: AC 2, 4]
  - [ ] Subtask 7.3: Create `CreateCompanyDto` interface (excludes `id`, `userId`, `createdAt`, `updatedAt`). [Source: API contract]

- [ ] **Task 8: Create Frontend Company Service Layer (AC: 2)**
  - [ ] Subtask 8.1: Create `apps/web/src/services/companyService.ts` using centralized `apiClient`. [Source: architecture/10-frontend-architecture.md#api-client-setup]
  - [ ] Subtask 8.2: Implement `createCompany(data: CreateCompanyDto)` function calling `POST /api/v1/companies`. [Source: architecture/10-frontend-architecture.md#service-example]
  - [ ] Subtask 8.3: Implement `getMyCompany()` function calling `GET /api/v1/companies/me`. [Source: AC 2]
  - [ ] Subtask 8.4: Implement `updateCompany(id, data)` function for future use. [Source: Future-proofing]

- [ ] **Task 9: Create Company Profile Setup Page (AC: 2)**
  - [ ] Subtask 9.1: Create `apps/web/src/pages/employer/setup-profile.tsx` route for `/employer/setup-profile`. [Source: architecture/10-frontend-architecture.md#route-organization]
  - [ ] Subtask 9.2: Page displays `CompanyProfileForm` component with clear instructions. [Source: AC 2]
  - [ ] Subtask 9.3: On form submission, call `companyService.createCompany()` and handle response. [Source: AC 2]
  - [ ] Subtask 9.4: On success, redirect employer to dashboard at `/employer/dashboard`. [Source: UX flow]
  - [ ] Subtask 9.5: Add "Skip for now" option that still redirects to dashboard (company can be created later). [Source: UX flexibility]

- [ ] **Task 10: Implement Post-Login Company Profile Check (AC: 2)**
  - [ ] Subtask 10.1: Update login flow to check if authenticated user is RECRUITER role. [Source: AC 2]
  - [ ] Subtask 10.2: If RECRUITER, call `companyService.getMyCompany()` to check if company profile exists. [Source: AC 2]
  - [ ] Subtask 10.3: If company profile does NOT exist, redirect to `/employer/setup-profile` page. [Source: AC 2 - first login prompt]
  - [ ] Subtask 10.4: If company profile exists, redirect to `/employer/dashboard`. [Source: Normal flow]
  - [ ] Subtask 10.5: If JOB_SEEKER, redirect to homepage or `/jobs`. [Source: User flow separation]

- [ ] **Task 11: Update Navigation for Role-Based UI (AC: 3)**
  - [ ] Subtask 11.1: Update main navigation component to display different menu items based on user role. [Source: AC 3 - different permissions]
  - [ ] Subtask 11.2: For RECRUITER: Show "Dashboard", "Post Job", "My Jobs" menu items. [Source: Employer UX]
  - [ ] Subtask 11.3: For JOB_SEEKER: Show "Jobs", "My Applications", "Saved Jobs" menu items. [Source: Job Seeker UX]
  - [ ] Subtask 11.4: Hide role-specific menu items when not authenticated. [Source: Security]

- [ ] **Task 12: Implement Backend Unit Tests (AC: 3, 4)**
  - [ ] Subtask 12.1: Write unit test for `CompanyService.createCompany()` to verify company creation. [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 12.2: Write unit test to verify one company per employer constraint. [Source: Business logic]
  - [ ] Subtask 12.3: Write unit test for role-based authorization (RECRUITER can access, JOB_SEEKER cannot). [Source: AC 3]
  - [ ] Subtask 12.4: Place tests in `apps/api/src/test/java/com/recruitify/service/CompanyServiceTest.java`. [Source: architecture/16-testing-strategy.md#test-organization]

- [ ] **Task 13: Implement Backend Integration Tests (AC: 2, 4)**
  - [ ] Subtask 13.1: Write integration test for `POST /api/v1/companies` endpoint (full request/response). [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 13.2: Write integration test for `GET /api/v1/companies/me` endpoint. [Source: AC 2]
  - [ ] Subtask 13.3: Verify 403 Forbidden when JOB_SEEKER tries to access RECRUITER endpoint. [Source: AC 3]
  - [ ] Subtask 13.4: Verify proper validation errors for invalid company data. [Source: architecture/15-security-and-performance.md]
  - [ ] Subtask 13.5: Place tests in `apps/api/src/test/java/com/recruitify/controller/CompanyControllerIntegrationTest.java`. [Source: architecture/16-testing-strategy.md#test-organization]

- [ ] **Task 14: Implement Frontend Component Tests (AC: 2)**
  - [ ] Subtask 14.1: Write unit test for `CompanyProfileForm` to verify form renders all fields. [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 14.2: Write unit test to verify form validation (required fields, URL format). [Source: AC 2]
  - [ ] Subtask 14.3: Write unit test for successful form submission. [Source: AC 2]
  - [ ] Subtask 14.4: Place test co-located: `CompanyProfileForm.test.tsx`. [Source: architecture/16-testing-strategy.md#test-organization]

- [ ] **Task 15: Implement E2E Tests (AC: 1, 2, 3)**
  - [ ] Subtask 15.1: Create Playwright E2E test for employer registration flow with role selection. [Source: AC 1]
  - [ ] Subtask 15.2: Verify after registration, employer is redirected to company profile setup page. [Source: AC 2]
  - [ ] Subtask 15.3: Verify employer can complete company profile form and is redirected to dashboard. [Source: AC 2, 4]
  - [ ] Subtask 15.4: Verify existing employer with company profile goes directly to dashboard on login. [Source: AC 2]
  - [ ] Subtask 15.5: Verify JOB_SEEKER cannot access employer-only pages (403 or redirect). [Source: AC 3]
  - [ ] Subtask 15.6: Place tests in `e2e/employer-registration.spec.ts`. [Source: architecture/16-testing-strategy.md#test-organization]

**Dev Notes**

**Previous Story Dependencies**: This story builds on Story 1.2 (Basic Job Seeker Registration & Login). The authentication system, JWT implementation, and user registration flow from Story 1.2 must be complete before implementing this story. Specifically, the `User` entity, registration endpoint, and auth flow are prerequisites.

**Role-Based Access Control (RBAC)**: This story introduces role-based permissions for the first time in the platform. The backend must distinguish between JOB_SEEKER and RECRUITER roles at multiple levels:
1. **Database Level**: `users.role` column stores the role
2. **JWT Level**: Role is included in JWT claims for stateless authorization
3. **Spring Security Level**: `@PreAuthorize` annotations enforce role-based access
4. **Frontend Level**: UI conditionally renders based on user role

**Data Models**:

*   **User Model (Enhanced from Story 1.2)**:
    *   Already exists with `role: 'JOB_SEEKER' | 'RECRUITER'` field
    *   [Source: architecture/4-data-models.md#model-user]

*   **Company Model (New)**:
    *   `id`: `string` (UUID) - Primary key
    *   `userId`: `string` (UUID, FK to User) - Links to the employer (RECRUITER) user
    *   `name`: `string` - Company name (required)
    *   `website`: `string` - Company website URL (optional)
    *   `description`: `string` - Company description (required)
    *   `logoUrl`: `string` - URL to company logo in S3 (optional, for future use)
    *   `createdAt`: `Date` - Timestamp
    *   `updatedAt`: `Date` - Timestamp
    *   [Source: Inferred from AC 2, 4 and PRD requirements]

*   **Relationships**:
    *   `Company` belongs to one `User` (with role RECRUITER)
    *   One-to-one relationship: Each RECRUITER user has at most one Company
    *   [Source: Business logic from AC 4]

**TypeScript Interfaces**:

```typescript
// In packages/shared-types/company.ts
export interface Company {
  id: string;
  userId: string;
  name: string;
  website?: string;
  description: string;
  logoUrl?: string;
  createdAt: Date;
  updatedAt: Date;
}

export interface CreateCompanyDto {
  name: string;
  website?: string;
  description: string;
}

export interface UpdateCompanyDto {
  name?: string;
  website?: string;
  description?: string;
}
```

```typescript
// Update to packages/shared-types/auth.ts (from Story 1.2)
export interface RegisterDto {
  email: string;
  password: string;
  role: 'JOB_SEEKER' | 'RECRUITER';  // NEW FIELD
}
```

**API Specifications**:

*   **POST /api/v1/auth/register** (Updated from Story 1.2):
    *   Request body now includes `role: 'JOB_SEEKER' | 'RECRUITER'`
    *   Creates user with specified role
    *   Returns 201 Created with JWT token
    *   [Source: AC 1]

*   **POST /api/v1/companies**:
    *   Creates company profile for authenticated RECRUITER
    *   Requires authentication + RECRUITER role
    *   Request body: `CreateCompanyDto`
    *   Returns 201 Created with `Company` object
    *   Returns 403 Forbidden if user is not RECRUITER
    *   Returns 400 Bad Request if employer already has a company
    *   [Source: AC 2, 4]

*   **GET /api/v1/companies/me**:
    *   Retrieves current employer's company profile
    *   Requires authentication + RECRUITER role
    *   Returns 200 OK with `Company` object
    *   Returns 404 Not Found if no company exists
    *   Returns 403 Forbidden if user is not RECRUITER
    *   [Source: AC 2]

*   **PUT /api/v1/companies/{id}**:
    *   Updates company profile
    *   Requires authentication + RECRUITER role + ownership verification
    *   Request body: `UpdateCompanyDto`
    *   Returns 200 OK with updated `Company` object
    *   [Source: Future-proofing for Story 2.3]

**Database Schema**:

```sql
-- Companies table (new)
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    website VARCHAR(500),
    description TEXT NOT NULL,
    logo_url VARCHAR(500),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_companies_user_id ON companies (user_id);

-- Constraint: One company per employer user
-- (Enforced by UNIQUE constraint on user_id)
```
[Source: Inferred from architecture/9-database-schema.md patterns and AC 4]

**Component Specifications**:

*   **CompanyProfileForm**: Form component with Company Name (text input), Website (URL input with validation), Description (textarea). Uses Ant Design components with proper validation and error messages. [Source: architecture/10-frontend-architecture.md and AC 2]

**File Locations**:

*   **Backend**:
    *   Entity: `apps/api/src/main/java/com/recruitify/entities/Company.java`
    *   Repository: `apps/api/src/main/java/com/recruitify/repository/CompanyRepository.java`
    *   Service: `apps/api/src/main/java/com/recruitify/service/CompanyService.java`
    *   Controller: `apps/api/src/main/java/com/recruitify/controller/CompanyController.java`
    *   DTOs: `apps/api/src/main/java/com/recruitify/dto/CreateCompanyDto.java`, `UpdateCompanyDto.java`
    *   Database Migration: `apps/api/src/main/resources/db/migration/V3__create_companies_table.sql` (or Liquibase equivalent)

*   **Frontend**:
    *   Pages: `apps/web/src/pages/employer/setup-profile.tsx`
    *   Components: `apps/web/src/features/employer/CompanyProfileForm.tsx`
    *   Services: `apps/web/src/services/companyService.ts`
    *   Updated: `apps/web/src/pages/auth/register.tsx` (add role selection)
    *   Updated: `apps/web/src/stores/useAuthStore.ts` (handle post-login redirect logic)

*   **Shared Types**: `packages/shared-types/company.ts`, update `packages/shared-types/auth.ts`

**Testing Requirements**:

*   **Unit Tests:**
    *   Backend: Test `CompanyService` methods, role-based authorization logic using JUnit 5 & Mockito
    *   Frontend: Test `CompanyProfileForm` component using Jest & React Testing Library
    *   [Source: architecture/16-testing-strategy.md]

*   **Integration Tests:**
    *   Backend: Test full API request/response cycles for all company endpoints
    *   Verify RBAC enforcement (403 for wrong role)
    *   [Source: architecture/16-testing-strategy.md]

*   **E2E Tests:**
    *   Test complete employer registration flow with role selection
    *   Test company profile creation after first login
    *   Test role-based navigation and access control
    *   [Source: architecture/16-testing-strategy.md]

**Technical Constraints**:

*   **One Company Per Employer**: Database must enforce unique constraint on `user_id` in companies table. Backend service should also validate this. [Source: AC 4]
*   **Role-Based Authorization**: All employer-specific endpoints must check for RECRUITER role using Spring Security's `@PreAuthorize`. [Source: AC 3]
*   **JWT Claims**: JWT must include user role to enable stateless authorization. [Source: architecture/11-backend-architecture.md]
*   **Input Validation**: Company name (max 255 chars, required), website (valid URL format if provided), description (max 2000 chars, required). [Source: architecture/15-security-and-performance.md]
*   **Post-Login Flow**: Frontend must check user role and company existence after login to determine correct redirect. [Source: AC 2]

**Naming Conventions**:

*   React components: `PascalCase` (e.g., `CompanyProfileForm.tsx`)
*   React hooks: `useCamelCase` (e.g., `useAuthStore.ts`)
*   Java classes: `PascalCase` (e.g., `CompanyController.java`)
*   API endpoints: `kebab-case` (e.g., `/api/v1/companies`)
*   Database tables: `snake_case` (e.g., `companies`)
*   Database columns: `snake_case` (e.g., `user_id`, `created_at`)
*   [Source: architecture/17-coding-standards.md]

**Security Considerations**:

*   **Role Verification**: Backend must verify user role on every protected endpoint, never trust frontend role checks alone. [Source: architecture/15-security-and-performance.md]
*   **Ownership Verification**: When updating company profile, verify the company belongs to the authenticated user. [Source: Security best practice]
*   **Input Sanitization**: Sanitize company description to prevent XSS attacks. [Source: architecture/15-security-and-performance.md#frontend-security]
*   **URL Validation**: Validate website URL format and protocol (https only in production). [Source: Security best practice]

**UX Considerations**:

*   **Optional Company Setup**: Allow employers to skip company profile setup and complete it later from their dashboard (AC 2 says "prompted", not "required"). [Source: UX flexibility]
*   **Clear Role Selection**: Registration form should clearly explain the difference between Job Seeker and Employer account types. [Source: AC 1]
*   **Progress Indicator**: Show "Step 1 of 2: Create Account" and "Step 2 of 2: Company Profile" to set expectations. [Source: UX best practice]

**Change Log**

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-11-06 | 1.0 | Initial draft based on Epic 2, Story 2.1 | Bob (SM) |

**Dev Agent Record**

**Agent Model Used**
{{agent_model_name_version}}

**Debug Log References**

**Completion Notes List**

**File List**

**QA Results**
