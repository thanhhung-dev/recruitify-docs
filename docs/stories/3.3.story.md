# Story 3.3: Basic Employer Applicant Management

**Status**: Draft

**Story**

As a logged-in employer,
I want to change the status of an applicant within my dashboard,
so that I can manage my hiring pipeline and track candidate progression.

**Acceptance Criteria**

1. When viewing the list of applicants for a job, an employer can change the status for each applicant.
2. The available status options are: "New," "Under Review," "Interview," and "Closed" (for hired or rejected).
3. Changing the status updates the application record in the database.
4. The applicant list on the employer's dashboard visually reflects the updated status for each candidate.

**Tasks / Subtasks**

- [ ] **Task 1: Create Backend API to Update Application Status (AC: 1, 2, 3)**
  - [ ] Subtask 1.1: Update `ApplicationService` with `updateApplicationStatus(applicationId, newStatus, recruiterId)` method. [Source: Story 2.5 foundation]
  - [ ] Subtask 1.2: Verify recruiter owns the job associated with the application before allowing status change. [Source: Story 2.5 security patterns]
  - [ ] Subtask 1.3: Update `Application` entity's `status` field and `updatedAt` timestamp. [Source: Story 2.4 data model]
  - [ ] Subtask 1.4: Use `ApplicationRepository.save()` to persist status change. [Source: architecture/11-backend-architecture.md]
  - [ ] Subtask 1.5: Return updated `ApplicationDetail` object after successful status change. [Source: AC 3]

- [ ] **Task 2: Create Status Update Endpoint (AC: 1, 2, 3)**
  - [ ] Subtask 2.1: Update `ApplicationController` with `PUT /api/v1/applications/{id}/status` endpoint. [Source: architecture/11-backend-architecture.md]
  - [ ] Subtask 2.2: Endpoint requires authentication and RECRUITER role. [Source: Story 2.5 security]
  - [ ] Subtask 2.3: Accept `UpdateApplicationStatusDto` with `status` field in request body. [Source: AC 2]
  - [ ] Subtask 2.4: Validate status is one of: NEW, UNDER_REVIEW, INTERVIEW, CLOSED. [Source: AC 2]
  - [ ] Subtask 2.5: Extract recruiter ID from JWT token for ownership verification. [Source: Story 2.5 security]
  - [ ] Subtask 2.6: Return 200 OK with updated `ApplicationDetail` on success. [Source: REST best practices]
  - [ ] Subtask 2.7: Return 403 Forbidden if recruiter doesn't own the job. [Source: Security]
  - [ ] Subtask 2.8: Return 404 Not Found if application doesn't exist. [Source: REST best practices]
  - [ ] Subtask 2.9: Return 400 Bad Request for invalid status values. [Source: Input validation]

- [ ] **Task 3: Create UpdateApplicationStatusDto (AC: 2)**
  - [ ] Subtask 3.1: Create `UpdateApplicationStatusDto` in `apps/api/src/main/java/com/recruitify/dto/`. [Source: architecture/17-coding-standards.md]
  - [ ] Subtask 3.2: Add `status` field with validation: `@NotNull`, `@Pattern(regexp="NEW|UNDER_REVIEW|INTERVIEW|CLOSED")`. [Source: AC 2 and architecture/15-security-and-performance.md]
  - [ ] Subtask 3.3: Add appropriate getters/setters and constructors. [Source: Java patterns]

- [ ] **Task 4: Update Shared TypeScript Types for Status Management (AC: 2)**
  - [ ] Subtask 4.1: Ensure `ApplicationStatus` type in `packages/shared-types/application.ts` includes all statuses. [Source: Story 2.4 foundation]
  - [ ] Subtask 4.2: Add `UpdateApplicationStatusRequest` interface with `status: ApplicationStatus` field. [Source: AC 2]
  - [ ] Subtask 4.3: Verify type alignment with backend enum values. [Source: architecture/17-coding-standards.md]

- [ ] **Task 5: Create Frontend Service for Status Updates (AC: 1, 3)**
  - [ ] Subtask 5.1: Update `apps/web/src/services/applicantService.ts` with `updateApplicationStatus(applicationId, status)`. [Source: architecture/10-frontend-architecture.md]
  - [ ] Subtask 5.2: Function calls `PUT /api/v1/applications/{id}/status` with authentication. [Source: AC 1, 3]
  - [ ] Subtask 5.3: Return type `Promise<ApplicationDetail>`. [Source: TypeScript types]
  - [ ] Subtask 5.4: Handle error responses (403, 404, 400) appropriately. [Source: Error handling]

- [ ] **Task 6: Update Applicants Store for Status Management (AC: 3, 4)**
  - [ ] Subtask 6.1: Update `apps/web/src/stores/useApplicantsStore.ts` with status update actions. [Source: Story 2.5 foundation]
  - [ ] Subtask 6.2: Create action `updateApplicantStatus(applicationId, newStatus)` that calls applicantService. [Source: AC 1, 3]
  - [ ] Subtask 6.3: Update local state optimistically to reflect status change immediately. [Source: UX best practice]
  - [ ] Subtask 6.4: Revert optimistic update if API call fails. [Source: Error handling]
  - [ ] Subtask 6.5: Update applicant count by status in dashboard if needed. [Source: AC 4]

- [ ] **Task 7: Create Status Dropdown Component (AC: 1, 2, 4)**
  - [ ] Subtask 7.1: Create `apps/web/src/features/employer/ApplicationStatusDropdown.tsx` component. [Source: architecture/10-frontend-architecture.md]
  - [ ] Subtask 7.2: Use Ant Design `Select` component with status options. [Source: architecture/3-tech-stack.md]
  - [ ] Subtask 7.3: Options: "New" (NEW), "Under Review" (UNDER_REVIEW), "Interview" (INTERVIEW), "Closed" (CLOSED). [Source: AC 2]
  - [ ] Subtask 7.4: Color-code statuses: NEW (blue), UNDER_REVIEW (orange), INTERVIEW (green), CLOSED (gray). [Source: UX best practice]
  - [ ] Subtask 7.5: On selection change, call store action to update status. [Source: AC 1, 3]
  - [ ] Subtask 7.6: Show loading state while status is being updated. [Source: UX feedback]
  - [ ] Subtask 7.7: Show success notification after status update. [Source: UX feedback]
  - [ ] Subtask 7.8: Show error notification if status update fails. [Source: Error handling]

- [ ] **Task 8: Update ApplicantsList Component with Status Dropdown (AC: 1, 4)**
  - [ ] Subtask 8.1: Update `apps/web/src/features/employer/ApplicantsList.tsx` from Story 2.5. [Source: Story 2.5 foundation]
  - [ ] Subtask 8.2: Add `ApplicationStatusDropdown` to each row in Status column. [Source: AC 1]
  - [ ] Subtask 8.3: Pass current application status and ID to dropdown component. [Source: AC 1]
  - [ ] Subtask 8.4: Ensure table reflects updated status immediately after change. [Source: AC 4]
  - [ ] Subtask 8.5: Update status badge styling to match dropdown color scheme. [Source: Visual consistency]

- [ ] **Task 9: Update ApplicantDetailModal with Status Dropdown (AC: 1, 4)**
  - [ ] Subtask 9.1: Update `apps/web/src/features/employer/ApplicantDetailModal.tsx` from Story 2.5. [Source: Story 2.5 foundation]
  - [ ] Subtask 9.2: Add `ApplicationStatusDropdown` to applicant detail view. [Source: AC 1]
  - [ ] Subtask 9.3: Position status dropdown prominently in header or actions section. [Source: UX best practice]
  - [ ] Subtask 9.4: Keep modal data in sync with status changes. [Source: AC 4]
  - [ ] Subtask 9.5: Close modal or refresh data after status change if needed. [Source: UX flow]

- [ ] **Task 10: Add Status Change Activity Tracking (AC: 3)**
  - [ ] Subtask 10.1: Log status changes in backend with timestamp, old status, new status, recruiter ID. [Source: Audit trail]
  - [ ] Subtask 10.2: Use application's `updatedAt` field to track last change. [Source: Story 2.4 data model]
  - [ ] Subtask 10.3: Consider adding separate audit log table for future detailed tracking. [Source: Future enhancement]

- [ ] **Task 11: Update Employer Dashboard Stats (AC: 4)**
  - [ ] Subtask 11.1: Update dashboard to show applicant counts by status. [Source: AC 4]
  - [ ] Subtask 11.2: Add visual breakdown: X New, Y Under Review, Z Interview, W Closed. [Source: Dashboard UX]
  - [ ] Subtask 11.3: Ensure dashboard stats update when status changes occur. [Source: AC 4]
  - [ ] Subtask 11.4: Use store state or fetch stats from backend. [Source: State management]

- [ ] **Task 12: Implement Backend Unit Tests (AC: 2, 3)**
  - [ ] Subtask 12.1: Write unit test for `ApplicationService.updateApplicationStatus()` with valid status. [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 12.2: Write unit test to verify ownership check prevents unauthorized status changes. [Source: Security]
  - [ ] Subtask 12.3: Write unit test to verify `updatedAt` timestamp is updated. [Source: AC 3]
  - [ ] Subtask 12.4: Write unit test to verify invalid status values are rejected. [Source: AC 2]
  - [ ] Subtask 12.5: Place tests in `apps/api/src/test/java/com/recruitify/service/ApplicationServiceTest.java`. [Source: architecture/16-testing-strategy.md]

- [ ] **Task 13: Implement Backend Integration Tests (AC: 1, 2, 3)**
  - [ ] Subtask 13.1: Write integration test for `PUT /api/v1/applications/{id}/status` endpoint. [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 13.2: Verify 200 OK response with updated application when status changes successfully. [Source: AC 3]
  - [ ] Subtask 13.3: Verify 403 Forbidden when recruiter doesn't own the job. [Source: Security]
  - [ ] Subtask 13.4: Verify 404 Not Found when application doesn't exist. [Source: Error handling]
  - [ ] Subtask 13.5: Verify 400 Bad Request when invalid status is provided. [Source: AC 2]
  - [ ] Subtask 13.6: Verify 401 Unauthorized when not authenticated. [Source: Security]
  - [ ] Subtask 13.7: Verify 403 Forbidden when JOB_SEEKER tries to access endpoint. [Source: RBAC]
  - [ ] Subtask 13.8: Place tests in `apps/api/src/test/java/com/recruitify/controller/ApplicationControllerIntegrationTest.java`. [Source: architecture/16-testing-strategy.md]

- [ ] **Task 14: Implement Frontend Component Tests (AC: 1, 4)**
  - [ ] Subtask 14.1: Write unit test for `ApplicationStatusDropdown` to verify it displays all status options. [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 14.2: Write unit test to verify dropdown calls update action on status change. [Source: AC 1]
  - [ ] Subtask 14.3: Write unit test to verify loading state during status update. [Source: UX coverage]
  - [ ] Subtask 14.4: Write unit test to verify success/error notifications. [Source: UX coverage]
  - [ ] Subtask 14.5: Place tests co-located: `ApplicationStatusDropdown.test.tsx`. [Source: architecture/16-testing-strategy.md]

- [ ] **Task 15: Implement E2E Tests (AC: 1, 2, 3, 4)**
  - [ ] Subtask 15.1: Create Playwright E2E test for recruiter changing applicant status. [Source: architecture/16-testing-strategy.md]
  - [ ] Subtask 15.2: Test logging in as recruiter and navigating to job applicants list. [Source: Story 2.5 flow]
  - [ ] Subtask 15.3: Test changing applicant status from "New" to "Under Review". [Source: AC 1, 2]
  - [ ] Subtask 15.4: Test verifying status change persists after page refresh. [Source: AC 3]
  - [ ] Subtask 15.5: Test changing status through multiple transitions (New → Under Review → Interview). [Source: AC 2]
  - [ ] Subtask 15.6: Test visual reflection of status change in applicant list. [Source: AC 4]
  - [ ] Subtask 15.7: Test JOB_SEEKER cannot access status change functionality. [Source: RBAC]
  - [ ] Subtask 15.8: Test recruiter cannot change status for applicants they don't own. [Source: Security]
  - [ ] Subtask 15.9: Place tests in `e2e/employer-applicant-management.spec.ts`. [Source: architecture/16-testing-strategy.md]

**Dev Notes**

**Previous Story Dependencies**: This story depends on:
- **Story 2.4** (Apply for a Job): The `Application` entity with `status` field and application submission flow
- **Story 2.5** (View Job Applicants): The applicant list UI, `ApplicantsList` and `ApplicantDetailModal` components, ownership verification patterns
- **Story 2.3** (Employer Dashboard): Dashboard structure where applicant status counts will be displayed
- **Story 3.1** (Job Seeker Applications): Connected story - status changes here affect what job seekers see in Story 3.4

This story completes the applicant management workflow by allowing employers to track candidates through their hiring pipeline. The status changes made here will be visible to job seekers in Story 3.4.

**Data Security & Authorization**: This story follows strict security principles from Story 2.5:
- **Ownership Verification**: Every status update MUST verify the recruiter owns the job associated with the application
- **Role-Based Access**: Only RECRUITER role can change applicant statuses
- **No Cross-Recruiter Access**: Recruiter A cannot change status for Recruiter B's applicants
- **User ID from JWT**: CRITICAL - Recruiter ID extracted from JWT token, never from request parameters

**Data Models**:

*   **Application Model (from Story 2.4)** - Updated status field:
    *   `status`: `'NEW' | 'UNDER_REVIEW' | 'INTERVIEW' | 'CLOSED'` - Application status
    *   `updatedAt`: `Date` - Timestamp updated when status changes
    *   [Source: Story 2.4 and AC 2, 3]

*   **UpdateApplicationStatusDto (New)**:
    *   `status`: `ApplicationStatus` - New status value
    *   Must be one of: NEW, UNDER_REVIEW, INTERVIEW, CLOSED
    *   [Source: AC 2]

**TypeScript Interfaces**:

```typescript
// In packages/shared-types/application.ts (extending existing from Story 2.4)

// ApplicationStatus already defined in Story 2.4:
// export type ApplicationStatus = 'NEW' | 'UNDER_REVIEW' | 'INTERVIEW' | 'CLOSED';

export interface UpdateApplicationStatusRequest {
  status: ApplicationStatus;
}

export interface ApplicationStatusUpdateResponse extends ApplicationDetail {
  // Returns full application details with updated status
}
```

**API Specifications**:

*   **PUT /api/v1/applications/{id}/status**:
    *   Updates the status of a specific application
    *   Requires authentication + RECRUITER role
    *   Verifies recruiter owns the job associated with application
    *   Request body: `UpdateApplicationStatusRequest` with `status` field
    *   Valid status values: "NEW", "UNDER_REVIEW", "INTERVIEW", "CLOSED"
    *   Returns 200 OK with updated `ApplicationDetail`
    *   Returns 400 Bad Request for invalid status values
    *   Returns 403 Forbidden if not job owner or not RECRUITER role
    *   Returns 404 Not Found if application doesn't exist
    *   Returns 401 Unauthorized if not authenticated
    *   Updates `updatedAt` timestamp automatically
    *   [Source: AC 1, 2, 3 and Story 2.5 patterns]

**Backend Implementation Example**:

```java
// In ApplicationService.java
public ApplicationDetail updateApplicationStatus(UUID applicationId, ApplicationStatus newStatus, UUID recruiterId) {
    Application application = applicationRepository.findById(applicationId)
        .orElseThrow(() -> new NotFoundException("Application not found"));

    JobPosting job = application.getJobPosting();

    // Security: Verify recruiter owns the job
    if (!job.getRecruiterId().equals(recruiterId)) {
        throw new ForbiddenException("You do not have permission to update this application");
    }

    // Update status and timestamp
    application.setStatus(newStatus);
    application.setUpdatedAt(LocalDateTime.now());

    Application updated = applicationRepository.save(application);

    return mapToApplicationDetail(updated);
}
```
[Source: AC 3 and Story 2.5 security patterns]

**Component Specifications**:

*   **ApplicationStatusDropdown**: Dropdown component for changing applicant status. Uses Ant Design `Select` with color-coded options. Handles optimistic updates and error recovery. Shows loading state and notifications. [Source: architecture/10-frontend-architecture.md and AC 1, 2]

*   **ApplicantsList** (Updated from Story 2.5): Table now includes interactive status dropdown in Status column. Status changes reflect immediately in the table. [Source: architecture/10-frontend-architecture.md and AC 1, 4]

*   **ApplicantDetailModal** (Updated from Story 2.5): Modal now includes status dropdown in header for easy status management while viewing applicant details. [Source: architecture/10-frontend-architecture.md and AC 1]

**File Locations**:

*   **Backend**:
    *   Service: `apps/api/src/main/java/com/recruitify/service/ApplicationService.java` (update existing)
    *   Controller: `apps/api/src/main/java/com/recruitify/controller/ApplicationController.java` (update existing)
    *   DTOs: `apps/api/src/main/java/com/recruitify/dto/UpdateApplicationStatusDto.java` (new)
    *   Entity: `apps/api/src/main/java/com/recruitify/entity/Application.java` (already exists from Story 2.4)

*   **Frontend**:
    *   Components: `apps/web/src/features/employer/ApplicationStatusDropdown.tsx` (new)
    *   Components: `apps/web/src/features/employer/ApplicantsList.tsx` (update from Story 2.5)
    *   Components: `apps/web/src/features/employer/ApplicantDetailModal.tsx` (update from Story 2.5)
    *   Services: `apps/web/src/services/applicantService.ts` (update existing)
    *   Stores: `apps/web/src/stores/useApplicantsStore.ts` (update existing from Story 2.5)

*   **Shared Types**: `packages/shared-types/application.ts` (update existing)

**Status Mapping & Display**:

| Backend Value | Display Label | Color Scheme | Meaning |
|--------------|---------------|--------------|---------|
| NEW | New | Blue (#1890FF) | Newly submitted application |
| UNDER_REVIEW | Under Review | Orange (#FA8C16) | Actively being reviewed |
| INTERVIEW | Interview | Green (#52C41A) | Candidate invited for interview |
| CLOSED | Closed | Gray (#8C8C8C) | Hired or rejected (final state) |

[Source: AC 2 and UX best practices]

**Security Considerations**:

*   **Authorization**: Only the recruiter who owns the job can change applicant statuses. [Source: Story 2.5 security patterns]
*   **Role-Based Access Control**: Only RECRUITER role can access status update endpoint. [Source: RBAC]
*   **Cross-Recruiter Access Prevention**: Integration tests MUST verify Recruiter A cannot change status for Recruiter B's applicants. [Source: Security testing]
*   **SQL Injection**: Use JPA parameterized queries (automatic protection). [Source: architecture/15-security-and-performance.md]
*   **Input Validation**: Backend validates status values against enum. [Source: architecture/15-security-and-performance.md]

**UX Considerations**:

*   **Optimistic Updates**: Status change reflects immediately in UI before backend confirmation for responsive feel. [Source: Modern UX patterns]
*   **Error Recovery**: Revert optimistic update if backend rejects the change. [Source: Error handling]
*   **Visual Feedback**: Show loading spinner on dropdown during update. [Source: User feedback]
*   **Notifications**: Success notification on status change, error notification on failure. [Source: User feedback]
*   **Color Coding**: Consistent color scheme across all status displays (dropdown, badges, stats). [Source: Visual consistency]
*   **Accessibility**: Dropdown accessible via keyboard, clear focus indicators. [Source: WCAG AA from PRD]

**Performance Considerations**:

*   **Single Query Update**: Status update requires only one UPDATE query plus ownership verification. [Source: architecture/15-security-and-performance.md]
*   **Optimistic UI Updates**: Reduce perceived latency by updating UI before API response. [Source: Performance UX]
*   **Batch Refresh**: If multiple statuses changed rapidly, batch refresh requests. [Source: Performance]

**Integration with Other Stories**:
- **Story 2.4**: Uses the Application entity and status field defined there
- **Story 2.5**: Extends the applicant viewing functionality with status management
- **Story 3.1**: Job seeker application history shows these statuses (read-only)
- **Story 3.4**: Status changes here will be visible to job seekers (future story)

**Future Enhancements** (Not in MVP):
*   Bulk status updates (change status for multiple applicants at once)
*   Status change history/audit trail with detailed logs
*   Automated status transitions based on actions (e.g., auto-close after X days)
*   Email notifications to job seekers when status changes
*   Custom status labels per company
*   Required notes/comments when changing to CLOSED status
*   Status change permissions (different recruiters have different status change rights)

**Testing**

**Unit Tests:**
*   **Backend**: Use JUnit 5 & Mockito. Test `ApplicationService.updateApplicationStatus()` with valid/invalid statuses, verify ownership checks, verify timestamp updates. [Source: architecture/16-testing-strategy.md]
*   **Frontend**: Use Jest & React Testing Library. Test status dropdown component, test option rendering, test update actions, test notifications. [Source: architecture/16-testing-strategy.md]

**Integration Tests:**
*   Backend controller-service-repository tests to verify full API request/response cycle with JWT authentication. Test various authorization scenarios: owns job, doesn't own job, wrong role, not authenticated. [Source: architecture/16-testing-strategy.md]

**E2E Tests:**
*   Use Playwright to test complete user journey: Login as recruiter → Navigate to applicants list → Change applicant status → Verify persistence → Check visual reflection. Test security: verify JOB_SEEKER blocked, cross-recruiter access blocked. [Source: architecture/16-testing-strategy.md]

**Change Log**

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-11-06 | 1.0 | Initial draft based on Epic 3, Story 3.3 | Bob (SM) |

**Dev Agent Record**

**Agent Model Used**
{{agent_model_name_version}}

**Debug Log References**

**Completion Notes List**

**File List**

**QA Results**
